-- Xóa các bảng cũ theo thứ tự phụ thuộc ngược lại để tránh lỗi khóa ngoại
DROP TABLE IF EXISTS user_reading_history;

DROP TABLE IF EXISTS user_library;

DROP TABLE IF EXISTS manga_people;

DROP TABLE IF EXISTS manga_tags;

DROP TABLE IF EXISTS chapter_pages;

DROP TABLE IF EXISTS chapters;

DROP TABLE IF EXISTS people;

DROP TABLE IF EXISTS tags;

DROP TABLE IF EXISTS users;

DROP TABLE IF EXISTS mangas;

-- --- TẠO LẠI CÁC BẢNG ---
-- Bảng 'mangas' (Bảng chính, tạo trước)
CREATE TABLE mangas (
  id VARCHAR(36) PRIMARY KEY,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  cover_filename VARCHAR(255),
  status ENUM('ongoing', 'completed', 'hiatus', 'cancelled') DEFAULT 'ongoing',
  publication_year INT,
  content_rating ENUM('safe', 'suggestive', 'erotica') DEFAULT 'safe',
  original_language VARCHAR(5),
  last_chapter_uploaded_at DATETIME,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_status (status),
  INDEX idx_year (publication_year),
  INDEX idx_last_chapter_uploaded_at (last_chapter_uploaded_at)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'chapters' (Phụ thuộc vào 'mangas')
CREATE TABLE chapters (
  id VARCHAR(36) PRIMARY KEY,
  manga_id VARCHAR(36) NOT NULL,
  chapter_number VARCHAR(20),
  title VARCHAR(255),
  language VARCHAR(5), -- Đã thêm cột language
  publish_date DATETIME,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (manga_id) REFERENCES mangas (id) ON DELETE CASCADE,
  INDEX idx_manga_id (manga_id),
  INDEX idx_publish_date (publish_date),
  INDEX idx_language (language) -- Index cho cột mới
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'chapter_pages' (Phụ thuộc vào 'chapters')
CREATE TABLE chapter_pages (
  id INT AUTO_INCREMENT PRIMARY KEY,
  chapter_id VARCHAR(36) NOT NULL,
  page_number INT NOT NULL,
  image_url VARCHAR(512) NOT NULL,
  FOREIGN KEY (chapter_id) REFERENCES chapters (id) ON DELETE CASCADE,
  INDEX idx_chapter_id (chapter_id),
  UNIQUE KEY unique_page (chapter_id, page_number)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'tags' (Bảng độc lập)
CREATE TABLE tags (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(100) NOT NULL UNIQUE,
  `group` VARCHAR(50)
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'manga_tags' (Bảng nối, phụ thuộc vào 'mangas' và 'tags')
CREATE TABLE manga_tags (
  manga_id VARCHAR(36) NOT NULL,
  tag_id VARCHAR(36) NOT NULL,
  PRIMARY KEY (manga_id, tag_id),
  FOREIGN KEY (manga_id) REFERENCES mangas (id) ON DELETE CASCADE,
  FOREIGN KEY (tag_id) REFERENCES tags (id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'people' (Bảng độc lập)
CREATE TABLE people (
  id VARCHAR(36) PRIMARY KEY,
  name VARCHAR(255) NOT NULL
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'manga_people' (Bảng nối, phụ thuộc vào 'mangas' và 'people')
CREATE TABLE manga_people (
  manga_id VARCHAR(36) NOT NULL,
  person_id VARCHAR(36) NOT NULL,
  `role` ENUM('author', 'artist') NOT NULL,
  PRIMARY KEY (manga_id, person_id, `role`),
  FOREIGN KEY (manga_id) REFERENCES mangas (id) ON DELETE CASCADE,
  FOREIGN KEY (person_id) REFERENCES people (id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'users' (Bảng độc lập)
CREATE TABLE users (
  id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(100) NOT NULL UNIQUE,
  email VARCHAR(255) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'user_library' (Phụ thuộc vào 'users' và 'mangas')
CREATE TABLE user_library (
  user_id INT NOT NULL,
  manga_id VARCHAR(36) NOT NULL,
  status ENUM(
    'reading',
    'completed',
    'on_hold',
    'dropped',
    'plan_to_read'
  ) DEFAULT 'reading',
  added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (user_id, manga_id),
  FOREIGN KEY (user_id) REFERENCES users (id) ON DELETE CASCADE,
  FOREIGN KEY (manga_id) REFERENCES mangas (id) ON DELETE CASCADE
) ENGINE = InnoDB DEFAULT CHARSET = utf8mb4 COLLATE = utf8mb4_unicode_ci;

-- Bảng 'user_reading_history' (Phụ thuộc vào 'users' và 'chapters')
CREATE TABLE user_reading_history (
  `id` INT NOT NULL AUTO_INCREMENT,
  `user_id` INT NOT NULL,
  `manga_id` VARCHAR(36) COLLATE utf8mb4_unicode_ci NOT NULL, 
  `chapter_id` VARCHAR(36) COLLATE utf8mb4_unicode_ci NOT NULL, 
  `last_read_at` TIMESTAMP NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `unique_user_manga` (`user_id`, `manga_id`), 
  FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`manga_id`) REFERENCES `mangas` (`id`) ON DELETE CASCADE,
  FOREIGN KEY (`chapter_id`) REFERENCES `chapters` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;